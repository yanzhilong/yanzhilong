@model TbPropertyMappingModel
@{
    ViewBag.sidebar = "淘宝属性分类";
    ViewBag.Title = "淘宝属性关联";
}

<div class="content-header clearfix">
    <h1 class="page-header">淘宝属性管理</h1>
</div>

<!-- 模版 -->
<script id="template" type="text/x-kendo-template">
    <a class="k-button" href="\#" onclick="template_click()">关联属性</a>
</script>

<div class="content">
    <div class="form-horizontal">
        <div class="panel-group">

            <div class="panel panel-default">
                <div id="grid"></div>
                

                <script>

                    var mWindow = null;

                    //添加子项目
                    function template_click() {
                        mWindow.data("kendoWindow").center().open();
                    }

                    $(document).ready(function () {
                        var ReadUrl = "@(Request.Url.GetLeftPart(UriPartial.Authority) + Url.Action("PropertyMappingList", "TbProperty"))" + "?TbPropertyCategoryId=" + "@Model.tbPropertyCategory.Id";
                        var DestroyUrl = "@(Request.Url.GetLeftPart(UriPartial.Authority) + Url.Action("DeletePropertyMappingList", "TbProperty"))"  + "?TbPropertyCategoryId=" + "@Model.tbPropertyCategory.Id",

                        dataSource = new kendo.data.DataSource({
                            transport: {
                                read: {
                                    url: ReadUrl,
                                    dataType: "jsonp"
                                },
                                destroy: {
                                    url: DestroyUrl,
                                    type: "post",
                                    dataType: "jsonp"
                                },
                                parameterMap: function (options, operation) {

                                    if (operation !== "read" && options.models) {
                                        return { models: kendo.stringify(options.models) };
                                    }
                                }
                            },
                            batch: true,
                            pageSize: 20,
                            schema: {
                                model: {
                                    id: "Id",
                                    fields: {
                                        Id: { editable: false, nullable: true },
                                        Name: { validation: { required: true } },
                                        ValueKey: { validation: { required: true } }
                                    }
                                }
                            }
                        });
                        dataSource.bind("error", dataSource_error);

                        function dataSource_error(e) {
                            var responsejson = e.xhr.responseText;
                            alert(e.status);
                        }

                        $("#grid").kendoGrid({
                            dataSource: dataSource,
                            sortable: true,
                            pageable: {
                                refresh: true,
                                pageSizes: true,
                                buttonCount: 5
                            },
                            toolbar: [{ template: kendo.template($("#template").html()) }],
                            columns: [
                                { field: "Name", title: "属性名称" },
                                { field: "ValueKey", title: "属性值" },
                                { command: ["destroy"], title: "&nbsp;", width: "200px" }
                            ],
                            editable: "popup"
                        });

                        //初始化添加检查单的窗口
                        mWindow = $("#Window");
                        mWindow.kendoWindow({
                            width: "600px",
                            title: "选择要关联的属性",
                            visible: false
                        }).data("kendoWindow");

                        //获得属性列表
                        GetPropertys();
                    });

                    function PropertySelect(checked) {
                        var url = "@Url.Action("CreatePropertyMappingList", "TbProperty")" + "?TbPropertyCategoryId=" + "@Model.tbPropertyCategory.Id";
                        $.ajax({
                            type: 'POST',
                            url: url,
                            data: { PropertyIds:checked },
                            success: function (data) {
                                if (data != null && data.success) {
                                    $('#grid').data('kendoGrid').dataSource.read();
                                    $('#grid').data('kendoGrid').refresh();
                                } else {
                                    alert(data.responseText);
                                }
                            },
                            error: function (xhr, ajaxOptions, thrownError) {
                                alert(thrownError);
                            }
                        });
                    }

                </script>
            </div>
        </div>
    </div>
</div>

<div id="Window" style="height:600px">
    <!-- 故障描述选择窗口 -->
    @Html.Partial("PropertySelect")
</div>